<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŠ“ç…¤çƒ - ç‹¡çŒ¾èº²è—ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; touch-action: none; font-family: sans-serif; }
        canvas { display: block; }
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center;
            color: white; font-size: 24px; z-index: 10; cursor: pointer;
            flex-direction: column;
        }
        #score-board {
            position: absolute; top: 10px; left: 10px; font-size: 20px; font-weight: bold; color: #333; pointer-events: none;
            background: rgba(255,255,255,0.5); padding: 5px 10px; border-radius: 10px;
        }
        .instruction { font-size: 14px; margin-top: 10px; color: #ccc; }
    </style>
</head>
<body>

<div id="score-board">æŠ“è·: 0</div>
<div id="start-overlay">
    <div>ç‚¹å‡»å±å¹•å¼€å§‹</div>
    <div class="instruction">æ¯3æ¬¡å†²åˆºï¼Œç…¤çƒå°±ä¼šæºœå‡ºå±å¹•èº²èµ·æ¥...</div>
</div>
<canvas id="gameCanvas"></canvas>

<script>
const CONFIG = {
    MAX_COUNT: 1,         
    SPAWN_DELAY: 1500,    
    AUDIO_DELAY: 500,     
    GOLD_CHANCE: 0.05,    
    WANDER_SPEED: 2.0,    
    SPRINT_SPEED: 9.0,    
    RUN_SPEED: 13.0,      
    STOP_SOUND_THRESHOLD: 3.5, 
    SCARE_RADIUS: 180,    
    HIT_RADIUS: 60
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let score = 0;
let gameRunning = false;
let nextSpawnTime = 0;

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// --- ğŸµ éŸ³æ•ˆç®¡ç†å™¨ ---
const SoundMgr = {
    s_appear: new Audio('./ap.mp3'),
    s_move: new Audio('./move.mp3'),
    ctx: null,

    init: function() { 
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.s_appear.load();
        this.s_move.load();
        this.s_move.loop = true; 
    },
    
    playAppear: function() {
        this.s_appear.currentTime = 0;
        this.s_appear.play().catch(e=>{});
    },
    
    ensurePlaying: function() {
        if (this.s_move.paused) {
            this.s_move.play().catch(e=>{});
        }
    },

    ensureStopped: function() {
        if (!this.s_move.paused) {
            this.s_move.pause();
            this.s_move.currentTime = 0; 
        }
    },

    playPop: function() { 
        if(!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(200, this.ctx.currentTime);
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + 0.1);
    },
    
    playGold: function() {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1500, t);
        gain.gain.setValueAtTime(0.2, t);
        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.start(); osc.stop(t + 0.5);
    }
};

// --- è§†è§‰ç‰¹æ•ˆ ---
class PawPrint {
    constructor(x, y) {
        this.x = x; this.y = y; this.life = 1.0; this.angle = Math.random()*6.28;
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
        ctx.globalAlpha = this.life; ctx.fillStyle = 'rgba(255, 182, 193, 0.8)';
        ctx.beginPath(); ctx.ellipse(0, 0, 20, 15, 0, 0, Math.PI*2); ctx.fill();
        [[-18,-20],[-6,-28],[6,-28],[18,-20]].forEach(t=>{
            ctx.beginPath(); ctx.arc(t[0],t[1],8,0,Math.PI*2); ctx.fill();
        });
        ctx.restore(); this.life -= 0.01;
    }
}

class Particle {
    constructor(x, y, isGold) {
        this.x = x; this.y = y; this.isGold = isGold;
        this.size = Math.random()*4+2; this.life = 1.0;
        this.vx = (Math.random()-0.5)*3; this.vy = (Math.random()-0.5)*3;
    }
    update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.03; this.size*=0.9; }
    draw(ctx) {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.isGold ? '#FFD700' : '#333';
        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
    }
}

// --- ç…¤çƒç±» ---
class CoalBall {
    constructor() {
        this.sprintCounter = 0; // è®°å½•å†²åˆºæ¬¡æ•°
        this.reset(true); // true è¡¨ç¤ºç¬¬ä¸€æ¬¡ç”Ÿæˆ
    }

    reset(isFirstSpawn) {
        this.isGold = Math.random() < CONFIG.GOLD_CHANCE;
        this.radius = 40 + Math.random() * 10;
        
        // ä½ç½®ç”Ÿæˆé€»è¾‘
        if (Math.random() > 0.5) {
            this.x = Math.random() > 0.5 ? -60 : canvas.width + 60;
            this.y = Math.random() * canvas.height;
        } else {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() > 0.5 ? -60 : canvas.height + 60;
        }

        this.state = 'WAITING_FOR_AUDIO';
        this.visible = false;
        
        // æ’­æ”¾å‡ºç°éŸ³æ•ˆ
        SoundMgr.playAppear();
        
        setTimeout(() => {
            this.state = 'WANDER';
            this.visible = true;
        }, CONFIG.AUDIO_DELAY);

        this.scale = 0.1; 
        this.angle = Math.atan2(canvas.height/2 - this.y, canvas.width/2 - this.x);
        this.speed = CONFIG.WANDER_SPEED;
        this.wanderTimer = 0;
        this.timer = 0;
        this.blinkTimer = Math.random() * 200;
        this.eyeOffset = 0;
        
        // èº²è—ç›¸å…³çš„çŠ¶æ€
        this.isHidingRun = false; 
        this.hiddenTimer = 0;
    }

    // --- ç»Ÿä¸€çš„å†²åˆºè§¦å‘å™¨ ---
    triggerSprint(sourceX, sourceY) {
        // å¦‚æœå·²ç»åœ¨å†²åˆºæˆ–å·²ç»èº²èµ·æ¥äº†ï¼Œå¿½ç•¥
        if (this.state === 'SCARE' || this.state === 'HIDDEN') return;

        this.sprintCounter++;
        console.log("å†²åˆºæ¬¡æ•°:", this.sprintCounter);

        // æ¯ç¬¬3æ¬¡å†²åˆº (1, 2, [3], 4, 5, [6]...)ï¼Œè§¦å‘èº²è—æ¨¡å¼
        if (this.sprintCounter % 3 === 0) {
            this.isHidingRun = true;
            // é€Ÿåº¦åŠ æˆï¼Œç¡®ä¿èƒ½è·‘å‡ºå»
            this.speed = (sourceX ? CONFIG.RUN_SPEED : CONFIG.SPRINT_SPEED) * 1.2;
        } else {
            this.isHidingRun = false;
            this.speed = (sourceX ? CONFIG.RUN_SPEED : CONFIG.SPRINT_SPEED) * (this.isGold ? 1.5 : 1);
        }

        // è®¡ç®—è§’åº¦
        if (sourceX !== undefined) {
            // è¢«å“è·‘ï¼šèƒŒç¦»è§¦æ‘¸ç‚¹
            this.angle = Math.atan2(this.y - sourceY, this.x - sourceX) + (Math.random()-0.5);
        } else {
            // è‡ªä¸»å†²åˆºï¼šéšæœºå¾®è°ƒå½“å‰æ–¹å‘
            this.angle += (Math.random() - 0.5);
        }

        this.state = 'SCARE';
    }

    update() {
        // å¦‚æœå¤„äºâ€œèº²è—ä¸­â€çŠ¶æ€ (HIDDEN)ï¼Œåªå€’è®¡æ—¶
        if (this.state === 'HIDDEN') {
            this.hiddenTimer--;
            if (this.hiddenTimer <= 0) {
                // æ—¶é—´åˆ°ï¼Œé‡ç”Ÿå›æ¥
                this.reset(false);
            }
            return;
        }

        if (!this.visible) return; 

        this.timer++;
        
        // --- WANDER é€»è¾‘ ---
        if (this.state === 'WANDER') {
            if (this.scale < 1) this.scale += 0.05;

            this.wanderTimer--;
            if (this.wanderTimer <= 0) {
                this.angle += (Math.random() - 0.5) * 3.0; 
                this.wanderTimer = 40 + Math.random() * 60;
                
                // 25% æ¦‚ç‡è‡ªä¸»å†²åˆº
                if (Math.random() < 0.25) { 
                    this.triggerSprint(); // è°ƒç”¨ç»Ÿä¸€çš„è§¦å‘å™¨
                } else {
                    this.speed = CONFIG.WANDER_SPEED;
                }
            }
            
            // åªæœ‰åœ¨ã€ä¸æ˜¯ã€‘èº²è—è·‘è·¯çš„æ—¶å€™ï¼Œæ‰ç¢°å£åå¼¹
            if (!this.isHidingRun) {
                if (this.x < 50) this.angle = 0 + Math.random();
                if (this.x > canvas.width - 50) this.angle = Math.PI + Math.random();
                if (this.y < 50) this.angle = Math.PI/2 + Math.random();
                if (this.y > canvas.height - 50) this.angle = -Math.PI/2 + Math.random();
            }

            this.eyeOffset = Math.sin(this.timer/40) * 6; 
        }
        // --- SCARE (å†²åˆº) é€»è¾‘ ---
        else if (this.state === 'SCARE') {
            // å¦‚æœä¸æ˜¯ä¸ºäº†èº²è—è€Œè·‘ï¼Œå°±æ­£å¸¸å‡é€Ÿ
            if (!this.isHidingRun) {
                this.speed *= 0.96; 
                if (this.speed < CONFIG.WANDER_SPEED + 1) {
                    this.state = 'WANDER';
                }
            } else {
                // å¦‚æœæ˜¯èº²è—è·‘ï¼Œä¸å‡é€Ÿï¼Œä¿æŒé«˜é€Ÿå†²å‡ºå»ï¼
                // å¹¶ä¸”æ£€æµ‹æ˜¯å¦å·²ç»è·‘å‡ºå±å¹•
                if (this.x < -100 || this.x > canvas.width + 100 || 
                    this.y < -100 || this.y > canvas.height + 100) {
                    
                    // æˆåŠŸé€ƒè„±ï¼è¿›å…¥èº²è—çŠ¶æ€
                    this.state = 'HIDDEN';
                    this.visible = false;
                    SoundMgr.ensureStopped(); // è·‘å‡ºå»äº†å°±æ²¡å£°éŸ³äº†
                    
                    // éšæœºèº² 2åˆ°5ç§’ (60fps * 2~5)
                    this.hiddenTimer = (2 + Math.random() * 3) * 60;
                    console.log("èº²è—ä¸­...", this.hiddenTimer);
                    return;
                }
            }

            // æ‰æ¸£ç²’å­
            if (Math.random() > 0.4) particles.push(new Particle(this.x, this.y, this.isGold));
            this.eyeOffset = 0;
        }

        // --- éŸ³æ•ˆåŒæ­¥ ---
        // æ³¨æ„ï¼šHIDDENçŠ¶æ€å·²ç»åœ¨ä¸Šé¢returnäº†ï¼Œè¿™é‡Œä¸ç”¨ç®¡
        if (this.speed > CONFIG.STOP_SOUND_THRESHOLD) {
            SoundMgr.ensurePlaying();
        } else {
            SoundMgr.ensureStopped();
        }

        // ç‰©ç†ç§»åŠ¨
        let wiggle = Math.sin(this.timer / 4) * 2;
        this.x += Math.cos(this.angle) * this.speed - Math.sin(this.angle) * wiggle;
        this.y += Math.sin(this.angle) * this.speed + Math.cos(this.angle) * wiggle;

        this.blinkTimer--;
        if (this.blinkTimer <= 0) this.blinkTimer = 100 + Math.random() * 300;
    }

    draw(ctx) {
        if (!this.visible || this.state === 'HIDDEN') return;

        ctx.save();
        ctx.translate(this.x, this.y);

        let stretch = Math.min(this.speed / 15, 0.4); 
        let drawAngle = (this.speed > 0.5) ? this.angle : 0;
        
        ctx.rotate(drawAngle);
        ctx.scale(this.scale * (1 + stretch), this.scale * (1 - stretch));

        // å°¾å·´
        ctx.beginPath();
        ctx.moveTo(-this.radius+10, 0);
        ctx.quadraticCurveTo(-this.radius*2, Math.sin(this.timer/5)*12, -this.radius*2.8, 0);
        ctx.lineWidth = 7; ctx.strokeStyle = this.isGold?'#DAA520':'#333'; ctx.lineCap='round'; ctx.stroke();

        // èº«ä½“
        ctx.fillStyle = this.isGold ? '#FFD700' : 'black';
        ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fill();

        // çœ¼ç›
        let isBlinking = this.blinkTimer < 5;
        let eyeScale = (this.state === 'SCARE') ? 1.4 : 1;
        
        if (!isBlinking) {
            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.ellipse(12, -9, 9*eyeScale, 7*eyeScale, 0, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(12, 9, 9*eyeScale, 7*eyeScale, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black';
            let pX = 14 + this.eyeOffset;
            ctx.beginPath(); ctx.arc(pX, -9, 3.5, 0, Math.PI*2); ctx.arc(pX, 9, 3.5, 0, Math.PI*2); ctx.fill();
        } else {
            ctx.strokeStyle = '#666'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(5,-9); ctx.lineTo(19,-9); ctx.moveTo(5,9); ctx.lineTo(19,9); ctx.stroke();
        }

        ctx.restore();
    }

    checkInput(ix, iy) {
        if (!this.visible || this.state === 'HIDDEN') return 'MISS';

        let dist = Math.sqrt((ix-this.x)**2 + (iy-this.y)**2);
        
        if (dist < CONFIG.HIT_RADIUS) return 'HIT';
        if (dist < CONFIG.SCARE_RADIUS) {
            // è§¦å‘å†²åˆºï¼ˆä¼ å…¥åæ ‡ï¼Œè¡¨ç¤ºæ˜¯è¢«å“è·‘çš„ï¼‰
            this.triggerSprint(ix, iy);
            return 'SCARE';
        }
        return 'MISS';
    }
}

// --- æ¸¸æˆå¾ªç¯ ---
let coalBalls = [];
let particles = [];
let paws = [];

function loop() {
    if (!gameRunning) { requestAnimationFrame(loop); return; }

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let now = Date.now();

    // å¦‚æœåœºä¸Šæ²¡æœ‰ç…¤çƒï¼ˆéƒ½è¢«æŠ“äº†ï¼‰ï¼Œä¸”é‡ç”Ÿæ—¶é—´åˆ°äº†ï¼Œæ‰ç”Ÿæˆæ–°çš„
    // æ³¨æ„ï¼šå¦‚æœæ˜¯â€œèº²è—â€çŠ¶æ€ï¼ŒcoalBalls æ•°ç»„é‡Œä¾ç„¶æœ‰å¯¹è±¡ï¼Œåªæ˜¯ä¸æ˜¾ç¤ºï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šè§¦å‘ç”Ÿæˆ
    if (coalBalls.length < CONFIG.MAX_COUNT && now > nextSpawnTime) {
        coalBalls.push(new CoalBall());
    }

    for(let i=paws.length-1; i>=0; i--) {
        paws[i].draw(ctx);
        if(paws[i].life <= 0) paws.splice(i, 1);
    }
    for(let i=particles.length-1; i>=0; i--) {
        particles[i].update(); particles[i].draw(ctx);
        if(particles[i].life <= 0) particles.splice(i, 1);
    }
    for(let i=coalBalls.length-1; i>=0; i--) {
        let ball = coalBalls[i];
        ball.update();
        ball.draw(ctx);
        if(ball.dead) coalBalls.splice(i, 1);
    }

    document.getElementById('score-board').innerText = `æŠ“è·: ${score}`;
    requestAnimationFrame(loop);
}

function handleInput(x, y) {
    if (!gameRunning) return;
    paws.push(new PawPrint(x, y));
    
    for (let i = coalBalls.length - 1; i >= 0; i--) {
        let res = coalBalls[i].checkInput(x, y);
        if (res === 'HIT') {
            SoundMgr.ensureStopped();
            if (coalBalls[i].isGold) SoundMgr.playGold();
            else SoundMgr.playPop();
            score++;
            coalBalls[i].dead = true;
            nextSpawnTime = Date.now() + CONFIG.SPAWN_DELAY;
        }
    }
}

document.getElementById('start-overlay').addEventListener('click', function() {
    this.style.display = 'none';
    SoundMgr.init();
    gameRunning = true;
    nextSpawnTime = Date.now();
});

canvas.addEventListener('mousedown', e => handleInput(e.clientX, e.clientY));
canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    for(let t of e.touches) handleInput(t.clientX, t.clientY);
}, {passive: false});

loop();
</script>
</body>
</html>
